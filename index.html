<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Cash Book System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      body { font-family: Arial, sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
      
      /* --- LOGIN STYLES --- */
      .login-container { background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 300px; text-align: center; }
      .login-container h2 { color: #2c3e50; margin-bottom: 20px; }
      input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="month"], select {
        padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; 
      }
      .login-container input { width: 100%; margin: 10px 0; }
      button { background-color: #2980b9; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
      button:hover { background-color: #3498db; }
      button:disabled { background-color: #95a5a6; cursor: not-allowed; }
      #error-message { color: #e74c3c; margin-top: 15px; font-size: 14px; min-height: 20px; }
      
      /* --- APP LAYOUT STYLES --- */
      .app-container { display: none; width: 95%; max-width: 1400px; margin: 20px auto; align-self: flex-start; }
      .card { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
      
      /* Navigation */
      .nav-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px; }
      .nav-buttons button { background-color: #7f8c8d; margin-right: 10px; }
      .nav-buttons button.active { background-color: #2c3e50; }
      
      /* Summary Cards */
      .summary-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
      .summary-box { flex: 1; padding: 15px; border-radius: 8px; color: white; text-align: center; min-width: 200px; }
      .cash-bg { background-color: #27ae60; }
      .bank-bg { background-color: #2980b9; }
      .summary-title { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
      .summary-amount { font-size: 28px; font-weight: bold; margin-top: 5px; }

      /* Standard Table */
      .table-wrapper { overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; text-align: left; font-size: 13px; min-width: 800px; }
      th { background-color: #2c3e50; color: white; padding: 10px; border: 1px solid #ddd; }
      td { padding: 8px; border: 1px solid #ddd; }
      .bal-col { font-weight: bold; background-color: #f9f9f9; }

      /* --- T-FORMAT REPORT STYLES (FOLIO) --- */
      .folio-container { display: flex; width: 100%; gap: 0; border: 2px solid #000; flex-direction: row; }
      .folio-side { flex: 1; padding: 0; min-width: 50%; }
      .folio-side.left { border-right: 2px solid #000; }
      .folio-header { text-align: center; font-weight: bold; font-size: 16px; padding: 10px; border-bottom: 1px solid #000; background-color: #f0f0f0; }
      .folio-table th { background-color: #e0e0e0; color: #000; border: 1px solid #000; padding: 8px; text-align: center; font-size: 12px; }
      .folio-table td { border: 1px solid #000; padding: 6px; }
      .amount-col { text-align: right; width: 80px; }
      .closing-row { font-weight: bold; font-style: italic; background-color: #fafafa; }
      .total-row { font-weight: bold; font-size: 14px; background-color: #e0e0e0; }

      /* Responsive Form Layout */
      .entry-form-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      .entry-form-row > * { flex: 1 1 120px; }
      .entry-form-row > input[type="text"]:nth-child(2) { flex: 3 1 200px; } /* Details input */

      /* Print CSS to make the report look perfect on A4 Paper */
      @media print {
        body { background-color: white; padding: 0; margin: 0; }
        .nav-bar, .card:not(#report-print-area), #dashboard-view { display: none !important; }
        .app-container { width: 100%; margin: 0; padding: 0; }
        #report-print-area { box-shadow: none; border: none; padding: 0; margin: 0; }
      }
    </style>
</head>
<body>

    <div id="login-view" class="login-container">
      <h2>Office Cash Book</h2>
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <button onclick="attemptLogin()" id="login-btn" style="width: 100%; margin-top: 10px;">Secure Login</button>
      <div id="error-message"></div>
    </div>

    <div id="app-wrapper" class="app-container">
      
      <div class="nav-bar">
        <div class="nav-buttons">
          <button id="nav-dash" class="active" onclick="switchTab('dashboard')">Data Entry Dashboard</button>
          <button id="nav-rep" onclick="switchTab('report')">Monthly Folio Report</button>
        </div>
        <div>
          <span id="welcome-text" style="margin-right: 15px; font-weight: bold; color: #555;"></span>
          <button onclick="location.reload()" style="background-color: #e74c3c;">Log Out</button>
        </div>
      </div>

      <div id="dashboard-view">
        <div class="summary-container">
          <div class="summary-box cash-bg">
            <div class="summary-title">Current Cash in Hand</div>
            <div class="summary-amount" id="display-cash-bal">0.00</div>
          </div>
          <div class="summary-box bank-bg">
            <div class="summary-title">Current Bank Balance</div>
            <div class="summary-amount" id="display-bank-bal">0.00</div>
          </div>
        </div>

        <div class="card entry-form-row">
          <input type="date" id="entry-date" required>
          <input type="text" id="entry-details" placeholder="Particulars" required>
          <input type="text" id="entry-voucher" placeholder="Vch/Chq No.">
          <select id="entry-method">
            <option value="Cash">Cash</option>
            <option value="Bank">Bank</option>
          </select>
          <select id="entry-type">
            <option value="Receipt">Receipt (+)</option>
            <option value="Payment">Payment (-)</option>
          </select>
          <input type="number" id="entry-amount" placeholder="Amount" step="0.01" required>
          <button onclick="submitNewEntry()" id="submit-btn" style="background-color: #2c3e50;">Post Entry</button>
        </div>

        <div class="card table-wrapper">
          <table id="main-table">
            <thead>
              <tr>
                <th>Date</th><th>Particulars</th><th>Vch/Chq No.</th><th>Method</th>
                <th>Receipts (+)</th><th>Payments (-)</th><th class="bal-col">Cash Bal.</th><th class="bal-col">Bank Bal.</th><th>Entered By</th>
              </tr>
            </thead>
            <tbody id="ledger-body"></tbody>
          </table>
        </div>
      </div>

      <div id="report-view" style="display: none;">
        <div class="card" style="display: flex; gap: 15px; align-items: center; background-color: #fdfdfd; flex-wrap: wrap;">
          <h3 style="margin: 0; color: #2c3e50;">Generate Cash Book Page:</h3>
          <input type="month" id="report-month-picker" style="margin: 0;">
          <button onclick="generateReport()" id="generate-btn" style="background-color: #27ae60;">Calculate & Generate</button>
          
          <div style="margin-left: auto; display: flex; gap: 10px;">
              <button onclick="downloadPDF()" id="btn-pdf" style="background-color: #d35400;">Download PDF</button>
              <button onclick="window.print()" style="background-color: #7f8c8d;">Print</button>
          </div>
        </div>

        <div id="report-print-area" class="card table-wrapper" style="min-height: 400px; padding: 30px;">
          <h2 id="report-title" style="text-align: center; margin-top: 0;">Monthly Cash Book Report</h2>
          <div class="folio-container">
            <div class="folio-side left">
              <div class="folio-header">RECEIPTS (Dr.)</div>
              <table class="folio-table">
                <thead>
                  <tr><th style="width: 80px;">Date</th><th>Particulars</th><th style="width: 60px;">Vch/Chq</th><th class="amount-col">Cash</th><th class="amount-col">Bank</th></tr>
                </thead>
                <tbody id="report-receipts-body">
                  <tr><td colspan="5" style="text-align:center; padding: 20px;">Select a month and click Generate...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="folio-side">
              <div class="folio-header">PAYMENTS (Cr.)</div>
              <table class="folio-table">
                <thead>
                  <tr><th style="width: 80px;">Date</th><th>Particulars</th><th style="width: 60px;">Vch/Chq</th><th class="amount-col">Cash</th><th class="amount-col">Bank</th></tr>
                </thead>
                <tbody id="report-payments-body">
                  <tr><td colspan="5" style="text-align:center; padding: 20px;">Select a month and click Generate...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ---> PUT YOUR NEW API DEPLOYMENT LINK HERE! <---
      const API_URL = "https://script.google.com/macros/s/AKfycbygLYX4O94zUSJv-Etq9whOb32U8uc5M4Qi1MEjDW1oKO9Zq1jW4j8mGJQlEQXwr9QipA/exec"; 
      
      let currentUser = "";

      // --- CORE API COMMUNICATION FUNCTION ---
      async function apiCall(action, payload) {
        const data = { action: action, ...payload };
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Ensures zero cross-origin mobile blocks
                body: JSON.stringify(data)
            });
            return await response.json();
        } catch (error) {
            console.error("API Error:", error);
            return { success: false, message: "Network connection failed. Please check your internet." };
        }
      }

      // --- VIEW SWITCHER ---
      function switchTab(tab) {
        document.getElementById('dashboard-view').style.display = (tab === 'dashboard') ? 'block' : 'none';
        document.getElementById('report-view').style.display = (tab === 'report') ? 'block' : 'none';
        document.getElementById('nav-dash').className = (tab === 'dashboard') ? 'active' : '';
        document.getElementById('nav-rep').className = (tab === 'report') ? 'active' : '';
      }

      // --- LOGIN LOGIC ---
      async function attemptLogin() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        const btn = document.getElementById('login-btn');
        const err = document.getElementById('error-message');
        
        btn.innerHTML = "Verifying..."; btn.disabled = true; err.innerHTML = "";

        const response = await apiCall('verifyUser', { username: user, password: pass });

        if (response.success) {
          currentUser = response.name; 
          document.getElementById('login-view').style.display = 'none';
          document.getElementById('app-wrapper').style.display = 'block';
          document.getElementById('welcome-text').innerHTML = "User: " + currentUser;
          
          // Fetch initial data
          const dataResponse = await apiCall('getLedgerData', {});
          if(dataResponse.success) updateTable(dataResponse.data);
          
        } else {
          btn.innerHTML = "Secure Login"; btn.disabled = false;
          err.innerHTML = response.message || response.error;
        }
      }

      // --- DATA ENTRY LOGIC ---
      async function submitNewEntry() {
        const btn = document.getElementById('submit-btn');
        
        const entryData = {
          date: document.getElementById('entry-date').value,
          details: document.getElementById('entry-details').value,
          voucher: document.getElementById('entry-voucher').value,
          method: document.getElementById('entry-method').value,
          type: document.getElementById('entry-type').value,
          amount: document.getElementById('entry-amount').value
        };

        if(!entryData.date || !entryData.details || !entryData.amount) {
          alert("Please fill in Date, Particulars, and Amount."); return;
        }

        btn.disabled = true; btn.innerHTML = "Posting...";

        const response = await apiCall('addEntry', { entryData: entryData, userName: currentUser });

        if (response.success) {
            updateTable(response.data); 
            document.getElementById('entry-details').value = '';
            document.getElementById('entry-voucher').value = '';
            document.getElementById('entry-amount').value = '';
        } else {
            alert("Error posting entry: " + response.message);
        }
        btn.disabled = false; btn.innerHTML = "Post Entry";
      }

      // --- DASHBOARD TABLE UPDATE ---
      function updateTable(data) {
        const tbody = document.getElementById('ledger-body');
        tbody.innerHTML = ''; 

        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No entries found.</td></tr>';
          return;
        }

        const cleanCash = String(data[0][7] || "0").replace(/,/g, '');
        const cleanBank = String(data[0][8] || "0").replace(/,/g, '');
        document.getElementById('display-cash-bal').innerHTML = parseFloat(cleanCash).toFixed(2);
        document.getElementById('display-bank-bal').innerHTML = parseFloat(cleanBank).toFixed(2);

        for (let i = 0; i < data.length; i++) {
          const row = data[i];
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[4]}</td><td>${row[5]}</td><td>${row[6]}</td><td class="bal-col">${row[7]}</td><td class="bal-col">${row[8]}</td><td style="font-size: 0.85em; color: #7f8c8d;">${row[9]}</td>`;
          tbody.appendChild(tr);
        }
      }

      // --- REPORT GENERATION ---
      async function generateReport() {
        const selectedMonth = document.getElementById('report-month-picker').value; 
        if(!selectedMonth) { alert("Please select a month and year first."); return; }

        const btn = document.getElementById('generate-btn');
        btn.innerHTML = "Calculating..."; btn.disabled = true;

        const response = await apiCall('generateReport', { selectedMonth: selectedMonth });
        
        btn.innerHTML = "Calculate & Generate"; btn.disabled = false;
        
        if (response.success) renderReport(response, selectedMonth);
        else alert("Error generating report: " + response.message);
      }

      function renderReport(data, selectedMonth) {
        const rBody = document.getElementById('report-receipts-body');
        const pBody = document.getElementById('report-payments-body');
        rBody.innerHTML = ''; pBody.innerHTML = '';

        const dateInput = selectedMonth.split('-');
        const firstDayStr = "01/" + dateInput[1] + "/" + dateInput[0];

        rBody.innerHTML += `<tr class="closing-row"><td>${firstDayStr}</td><td>To Opening Balance b/d</td><td></td><td class="amount-col">${data.openingCash}</td><td class="amount-col">${data.openingBank}</td></tr>`;

        data.receipts.forEach(tx => {
          const cAmt = (tx.method === "Cash") ? tx.receipt.toFixed(2) : "";
          const bAmt = (tx.method === "Bank") ? tx.receipt.toFixed(2) : "";
          rBody.innerHTML += `<tr><td>${tx.dateStr}</td><td>${tx.particulars}</td><td>${tx.voucher}</td><td class="amount-col">${cAmt}</td><td class="amount-col">${bAmt}</td></tr>`;
        });

        data.payments.forEach(tx => {
          const cAmt = (tx.method === "Cash") ? tx.payment.toFixed(2) : "";
          const bAmt = (tx.method === "Bank") ? tx.payment.toFixed(2) : "";
          pBody.innerHTML += `<tr><td>${tx.dateStr}</td><td>${tx.particulars}</td><td>${tx.voucher}</td><td class="amount-col">${cAmt}</td><td class="amount-col">${bAmt}</td></tr>`;
        });

        pBody.innerHTML += `<tr class="closing-row"><td>End of Mth</td><td>By Closing Balance c/d</td><td></td><td class="amount-col">${data.closingCash}</td><td class="amount-col">${data.closingBank}</td></tr>`;

        const totalHtml = `<td colspan="3" style="text-align:right;">TOTAL:</td><td class="amount-col">${data.grandTotalCash}</td><td class="amount-col">${data.grandTotalBank}</td>`;
        rBody.innerHTML += `<tr class="total-row">${totalHtml}</tr>`;
        pBody.innerHTML += `<tr class="total-row">${totalHtml}</tr>`;
        
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        document.getElementById('report-title').innerHTML = `Cash Book Folio - ${monthNames[parseInt(dateInput[1]) - 1]} ${dateInput[0]}`;
      }

      // --- PDF GENERATION LOGIC ---
      function downloadPDF() {
        const element = document.getElementById('report-print-area');
        const monthInput = document.getElementById('report-month-picker').value;
        if(!monthInput) { alert("Please generate a report first."); return; }

        const btn = document.getElementById('btn-pdf');
        const originalText = btn.innerHTML;
        btn.innerHTML = "Generating..."; btn.disabled = true;

        const opt = {
          margin: 0.5,
          filename: 'CashBook_Report_' + monthInput + '.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
          btn.innerHTML = originalText; btn.disabled = false;
        });
      }
    </script>
</body>
</html>
