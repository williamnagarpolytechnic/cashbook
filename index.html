<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Cash Book System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      body { font-family: Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 10px; }
      
      .login-container { background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 90%; max-width: 320px; text-align: center; margin: 50px auto; }
      .login-container input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
      
      button { background-color: #2980b9; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
      button:hover { background-color: #3498db; }
      button:disabled { background-color: #95a5a6; cursor: not-allowed; }
      .btn-danger { background-color: #e74c3c; } .btn-danger:hover { background-color: #c0392b; }
      .btn-warning { background-color: #f39c12; } .btn-warning:hover { background-color: #e67e22; }
      
      .app-container { display: none; width: 100%; max-width: 1400px; margin: 0 auto; }
      .card { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
      
      /* --- MOBILE RESPONSIVE CSS --- */
      .nav-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
      .nav-buttons button { background-color: #7f8c8d; margin-right: 5px; margin-bottom: 5px; }
      .nav-buttons button.active { background-color: #2c3e50; }
      
      .summary-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
      .summary-box { flex: 1; padding: 15px; border-radius: 8px; color: white; text-align: center; min-width: 250px; }
      .cash-bg { background-color: #27ae60; } .bank-bg { background-color: #2980b9; }
      
      .entry-form-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      .entry-form-row > * { flex: 1 1 120px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
      .entry-form-row > input[type="text"]:nth-child(2) { flex: 3 1 200px; }
      
      .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      table { width: 100%; border-collapse: collapse; text-align: left; font-size: 13px; min-width: 800px; }
      th { background-color: #2c3e50; color: white; padding: 10px; border: 1px solid #ddd; }
      td { padding: 8px; border: 1px solid #ddd; }
      
      .folio-container { display: flex; width: 100%; border: 2px solid #000; flex-direction: row; }
      .folio-side { flex: 1; padding: 0; min-width: 50%; }
      .folio-side.left { border-right: 2px solid #000; }
      
      @media (max-width: 768px) {
        .folio-container { flex-direction: column; }
        .folio-side.left { border-right: none; border-bottom: 2px solid #000; }
        .entry-form-row > * { flex: 1 1 100%; } /* Stack form fields on mobile */
      }
      @media print { body, .app-container, .card { background: white; margin:0; padding:0; box-shadow: none; border:none; } .nav-bar, .card:not(#report-print-area) { display: none !important; } }
    </style>
</head>
<body>

    <div id="login-view" class="login-container">
      <h2>Office Cash Book</h2>
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <button onclick="attemptLogin()" id="login-btn" style="width: 100%;">Secure Login</button>
      <div id="error-message" style="color:red; margin-top:10px;"></div>
    </div>

    <div id="app-wrapper" class="app-container">
      
      <div class="nav-bar">
        <div class="nav-buttons">
          <button id="nav-dash" class="active" onclick="switchTab('dashboard')">Dashboard</button>
          <button id="nav-rep" onclick="switchTab('report')">Folio Report</button>
          <button id="nav-admin" onclick="switchTab('admin')" style="display:none; background-color:#8e44ad;">Admin Panel</button>
        </div>
        <div><span id="welcome-text" style="font-weight: bold; margin-right: 15px;"></span><button class="btn-danger" onclick="location.reload()">Log Out</button></div>
      </div>

      <div id="dashboard-view">
        <div class="summary-container">
          <div class="summary-box cash-bg"><div>Current Cash in Hand</div><h2 id="display-cash-bal">0.00</h2></div>
          <div class="summary-box bank-bg"><div>Current Bank Balance</div><h2 id="display-bank-bal">0.00</h2></div>
        </div>

        <div class="card entry-form-row" id="form-container">
          <input type="date" id="entry-date" required>
          <input type="text" id="entry-details" placeholder="Particulars" required>
          <input type="text" id="entry-voucher" placeholder="Vch/Chq No.">
          <select id="entry-method"><option value="Cash">Cash</option><option value="Bank">Bank</option></select>
          <select id="entry-type"><option value="Receipt">Receipt (+)</option><option value="Payment">Payment (-)</option></select>
          <input type="number" id="entry-amount" placeholder="Amount" step="0.01" required>
          <button onclick="submitNewEntry()" id="submit-btn">Post Entry</button>
          <button onclick="cancelEdit()" id="cancel-btn" style="display:none; background-color:#7f8c8d;">Cancel Edit</button>
        </div>

        <div class="card table-wrapper">
          <table>
            <thead>
              <tr id="table-header">
                <th>Date</th><th>Particulars</th><th>Vch/Chq</th><th>Method</th><th>Receipts (+)</th><th>Payments (-)</th><th>Cash Bal.</th><th>Bank Bal.</th><th>User</th>
                </tr>
            </thead>
            <tbody id="ledger-body"></tbody>
          </table>
        </div>
      </div>

      <div id="admin-view" style="display:none;">
        <div class="card">
          <h3 style="margin-top:0;">Add New User</h3>
          <div class="entry-form-row">
            <input type="text" id="new-user" placeholder="Username">
            <input type="text" id="new-pass" placeholder="Password">
            <input type="text" id="new-name" placeholder="Full Name">
            <select id="new-role"><option value="cashier">Cashier</option><option value="admin">Admin</option></select>
            <button onclick="addNewUser()" id="btn-add-user" style="background-color:#27ae60;">Create User</button>
          </div>
        </div>
        <div class="card table-wrapper">
          <h3 style="margin-top:0;">Manage System Users</h3>
          <table>
            <thead><tr><th>Username</th><th>Name</th><th>Status</th><th>Role</th><th>Actions</th></tr></thead>
            <tbody id="users-body"></tbody>
          </table>
        </div>
      </div>

<div id="report-view" style="display: none;">
        <div class="card" style="display: flex; gap: 15px; align-items: center; background-color: #fdfdfd; flex-wrap: wrap;">
          <h3 style="margin: 0; color: #2c3e50;">Generate Cash Book Page:</h3>
          <input type="month" id="report-month-picker" style="margin: 0;">
          <button onclick="generateReport()" id="generate-btn" style="background-color: #27ae60;">Calculate & Generate</button>
          
          <div style="margin-left: auto; display: flex; gap: 10px;">
              <button onclick="downloadPDF()" id="btn-pdf" style="background-color: #d35400;">Download PDF</button>
              <button onclick="window.print()" style="background-color: #7f8c8d;">Print</button>
          </div>
        </div>

        <div id="report-print-area" class="card table-wrapper" style="min-height: 400px; padding: 30px;">
          <h2 id="report-title" style="text-align: center; margin-top: 0;">Monthly Cash Book Report</h2>
          <div class="folio-container">
            <div class="folio-side left">
              <div class="folio-header">RECEIPTS (Dr.)</div>
              <table class="folio-table">
                <thead>
                  <tr><th style="width: 80px;">Date</th><th>Particulars</th><th style="width: 60px;">Vch/Chq</th><th class="amount-col">Cash</th><th class="amount-col">Bank</th></tr>
                </thead>
                <tbody id="report-receipts-body">
                  <tr><td colspan="5" style="text-align:center; padding: 20px;">Select a month and click Generate...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="folio-side">
              <div class="folio-header">PAYMENTS (Cr.)</div>
              <table class="folio-table">
                <thead>
                  <tr><th style="width: 80px;">Date</th><th>Particulars</th><th style="width: 60px;">Vch/Chq</th><th class="amount-col">Cash</th><th class="amount-col">Bank</th></tr>
                </thead>
                <tbody id="report-payments-body">
                  <tr><td colspan="5" style="text-align:center; padding: 20px;">Select a month and click Generate...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    <script>
      // ---> UPDATE THIS LINK WITH YOUR NEW /exec URL <---
      const API_URL = "https://script.google.com/macros/s/AKfycbwLfUWljga2U6vxA8fkY80p8q4ESQyNfJdVDrigpdzomLNCBcoBWDbJ2jj8UKzJJrzwcA/exec"; 
      
      let currentUser = "";
      let currentRole = "";
      let editingRow = null; // Stores row number if admin is correcting an entry

      async function apiCall(action, payload) {
        try {
            const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: action, ...payload }) });
            return await response.json();
        } catch (e) { alert("Network Error"); return { success: false }; }
      }

      function switchTab(tab) {
        document.getElementById('dashboard-view').style.display = (tab === 'dashboard') ? 'block' : 'none';
        document.getElementById('report-view').style.display = (tab === 'report') ? 'block' : 'none';
        document.getElementById('admin-view').style.display = (tab === 'admin') ? 'block' : 'none';
        
        document.getElementById('nav-dash').className = (tab === 'dashboard') ? 'active' : '';
        document.getElementById('nav-rep').className = (tab === 'report') ? 'active' : '';
        document.getElementById('nav-admin').className = (tab === 'admin') ? 'active' : '';
        
        if(tab === 'admin') loadUsers();
      }

      async function attemptLogin() {
        const u = document.getElementById('username').value, p = document.getElementById('password').value;
        const btn = document.getElementById('login-btn'); btn.innerHTML = "Verifying...";
        
        const res = await apiCall('verifyUser', { username: u, password: p });
        if (res.success) {
          currentUser = res.name; currentRole = res.role;
          document.getElementById('login-view').style.display = 'none';
          document.getElementById('app-wrapper').style.display = 'block';
          document.getElementById('welcome-text').innerHTML = `User: ${currentUser} (${currentRole.toUpperCase()})`;
          
          if(currentRole === 'admin') {
              document.getElementById('nav-admin').style.display = 'inline-block';
              document.getElementById('table-header').innerHTML += "<th>Admin Actions</th>";
          }
          
          const dataRes = await apiCall('getLedgerData', {});
          if(dataRes.success) updateTable(dataRes.data);
        } else {
          btn.innerHTML = "Secure Login"; document.getElementById('error-message').innerHTML = res.message;
        }
      }

      // --- TRANSACTION MANAGEMENT (Self-Healing) ---
      async function submitNewEntry() {
        const btn = document.getElementById('submit-btn');
        const entryData = {
          date: document.getElementById('entry-date').value,
          details: document.getElementById('entry-details').value,
          voucher: document.getElementById('entry-voucher').value,
          method: document.getElementById('entry-method').value,
          type: document.getElementById('entry-type').value,
          amount: document.getElementById('entry-amount').value
        };

        if(!entryData.date || !entryData.details || !entryData.amount) return alert("Fill required fields");
        btn.innerHTML = "Processing..."; btn.disabled = true;

        let res;
        if(editingRow) {
            // Send correction to backend self-healing engine
            res = await apiCall('updateTransaction', { rowNum: editingRow, entryData: entryData, userName: currentUser });
            editingRow = null;
            btn.style.backgroundColor = "#2c3e50";
            document.getElementById('cancel-btn').style.display = "none";
        } else {
            res = await apiCall('addEntry', { entryData: entryData, userName: currentUser });
        }

        if (res.success) {
            updateTable(res.data); 
            document.getElementById('entry-details').value = ''; document.getElementById('entry-amount').value = '';
        }
        btn.innerHTML = "Post Entry"; btn.disabled = false;
      }

      function loadTransactionForEdit(rowNum, dateStr, details, vch, method, rec, pay) {
        // Convert dd/mm/yyyy to yyyy-mm-dd for the HTML input
        const dParts = dateStr.split('/');
        document.getElementById('entry-date').value = `${dParts[2]}-${dParts[1]}-${dParts[0]}`;
        document.getElementById('entry-details').value = details;
        document.getElementById('entry-voucher').value = vch;
        document.getElementById('entry-method').value = method;
        document.getElementById('entry-type').value = (rec > 0) ? "Receipt" : "Payment";
        document.getElementById('entry-amount').value = (rec > 0) ? rec : pay;
        
        editingRow = rowNum;
        const btn = document.getElementById('submit-btn');
        btn.innerHTML = "Update Corrected Entry";
        btn.style.backgroundColor = "#f39c12"; // Orange alert color
        document.getElementById('cancel-btn').style.display = "inline-block";
        window.scrollTo(0, 0); // Scroll up to form
      }

      function cancelEdit() {
        editingRow = null;
        document.getElementById('entry-details').value = ''; document.getElementById('entry-amount').value = '';
        const btn = document.getElementById('submit-btn');
        btn.innerHTML = "Post Entry"; btn.style.backgroundColor = "#2c3e50";
        document.getElementById('cancel-btn').style.display = "none";
      }

      async function deleteTx(rowNum) {
        if(!confirm("Are you sure? This will delete the entry and recalculate all balances automatically.")) return;
        const res = await apiCall('deleteTransaction', { rowNum: rowNum });
        if(res.success) updateTable(res.data);
      }

      function updateTable(data) {
        const tbody = document.getElementById('ledger-body'); tbody.innerHTML = ''; 
        if (!data || data.length === 0) return;

        document.getElementById('display-cash-bal').innerHTML = parseFloat(String(data[0][7]).replace(/,/g, '') || "0").toFixed(2);
        document.getElementById('display-bank-bal').innerHTML = parseFloat(String(data[0][8]).replace(/,/g, '') || "0").toFixed(2);

        data.forEach(row => {
          let tr = `<tr><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[4]}</td><td>${row[5]}</td><td>${row[6]}</td><td class="bal-col">${parseFloat(row[7]).toFixed(2)}</td><td class="bal-col">${parseFloat(row[8]).toFixed(2)}</td><td>${row[9]}</td>`;
          
          // Inject Admin Edit/Delete buttons (Row 10 holds the actual spreadsheet row number)
          if(currentRole === 'admin') {
             tr += `<td>
                     <button class="btn-warning" onclick="loadTransactionForEdit(${row[10]}, '${row[1]}', '${row[2]}', '${row[3]}', '${row[4]}', ${parseFloat(row[5]||0)}, ${parseFloat(row[6]||0)})" style="padding:5px; font-size:11px;">Edit</button>
                     <button class="btn-danger" onclick="deleteTx(${row[10]})" style="padding:5px; font-size:11px;">Del</button>
                   </td>`;
          }
          tr += `</tr>`;
          tbody.innerHTML += tr;
        });
      }

      // --- USER MANAGEMENT ---
      async function loadUsers() {
          const res = await apiCall('getUsers', {});
          const tbody = document.getElementById('users-body'); tbody.innerHTML = '';
          if(res.success) {
              res.data.forEach(u => {
                  tbody.innerHTML += `<tr><td>${u[0]}</td><td>${u[2]}</td><td>${u[3]}</td><td>${u[4].toUpperCase()}</td>
                  <td>
                    <button class="btn-warning" onclick="changePass('${u[0]}')" style="padding:5px; font-size:11px;">Change Pass</button>
                    <button class="btn-danger" onclick="delUser('${u[0]}')" style="padding:5px; font-size:11px;">Delete</button>
                  </td></tr>`;
              });
          }
      }

      async function addNewUser() {
          const u = document.getElementById('new-user').value, p = document.getElementById('new-pass').value, n = document.getElementById('new-name').value, r = document.getElementById('new-role').value;
          if(!u || !p || !n) return alert("Fill all fields");
          await apiCall('addUser', { userData: {user: u, pass: p, name: n, role: r} });
          document.getElementById('new-user').value=''; document.getElementById('new-pass').value=''; document.getElementById('new-name').value='';
          loadUsers();
      }

      async function changePass(username) {
          const newPass = prompt(`Enter new password for ${username}:`);
          if(newPass) { await apiCall('updateUserPass', { username: username, newPass: newPass }); loadUsers(); }
      }

      async function delUser(username) {
          if(confirm(`Delete user ${username}?`)) { await apiCall('deleteUser', { username: username }); loadUsers(); }
      }
    </script>
</body>
</html>
